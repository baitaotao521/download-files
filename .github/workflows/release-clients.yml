name: Build Tkinter App

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        # 第一维：操作系统环境配置
        os_config:
          - { os: windows-latest, name: windows-x64, ext: .exe, icon: public/app.ico }
          - { os: ubuntu-latest,  name: linux-x64,   ext: "",   icon: public/app.ico }
          - { os: macos-latest,   name: macos-x64,   ext: "",   icon: public/app.ico }

        # 第二维：应用类型配置 (CLI vs Desktop)
        # 通过在这里定义差异参数，实现下方构建步骤的统一
        app_config:
          - { type: cli,     script: scripts/ws_downloader.py, out_name: feishu-downloader-cli,     console: true,  plugins: "",         product_name: "Feishu Downloader CLI" }
          - { type: desktop, script: scripts/ws_desktop.py,    out_name: feishu-downloader-desktop, console: false, plugins: "tk-inter", product_name: "Feishu Downloader" }

    runs-on: ${{ matrix.os_config.os }}
    name: Build ${{ matrix.os_config.name }} (${{ matrix.app_config.type }})

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install System Dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-tk tk-dev tcl-dev patchelf ccache

      - name: Install Dependencies
        run: |
          pip install -r scripts/requirements.txt
          # Nuitka 需要 imageio 来转换图标格式 (如 .ico -> .icns)
          pip install imageio

      - name: Parse Version for Nuitka
        id: parse_version
        shell: bash
        run: |
          RAW="${{ github.ref_name }}"
          VER="${RAW#v}"
          VER="${VER%%-*}"
          if [ -z "$VER" ]; then VER="0.0.0"; fi
          echo "clean_version=$VER" >> $GITHUB_OUTPUT

      - name: Setup Nuitka Cache
        uses: actions/cache@v4
        with:
          path: |
            var/cache/nuitka
            ~/.cache/Nuitka
            ~/AppData/Local/Nuitka/Nuitka/Cache
            ~/Library/Caches/Nuitka
          # 缓存 Key 加入了 matrix.app_config.type，区分 CLI 和 Desktop 的缓存，避免冲突
          key: ${{ runner.os }}-nuitka-${{ matrix.app_config.type }}-${{ hashFiles('scripts/requirements.txt') }}-${{ github.ref }}
          restore-keys: |
            ${{ runner.os }}-nuitka-${{ matrix.app_config.type }}-${{ hashFiles('scripts/requirements.txt') }}-

      # === 统一构建步骤 ===
      - name: Build ${{ matrix.app_config.type }}
        uses: Nuitka/Nuitka-Action@main
        with:
          script-name: ${{ matrix.app_config.script }}
          output-file: ${{ matrix.app_config.out_name }}${{ matrix.os_config.ext }}
          mode: onefile
          lto: yes

          # 动态参数：由 matrix 控制是否开启控制台、是否启用 tk-inter 插件
          enable-console: ${{ matrix.app_config.console }}
          enable-plugins: ${{ matrix.app_config.plugins }}

          # 通用资源配置
          # include-data-dir 只能放目录
          include-data-dir: |
            python_app/locales=python_app/locales
          # include-data-files 放具体文件 (源路径=目标路径)
          include-data-files: |
            ${{ matrix.os_config.icon }}=${{ matrix.os_config.icon }}
            python_app/_version.txt=python_app/_version.txt

          windows-icon-from-ico: ${{ matrix.os_config.icon }}
          macos-app-icon: ${{ matrix.os_config.icon }}

          # 元数据
          company-name: "YourCompany"
          product-name: ${{ matrix.app_config.product_name }}
          file-version: ${{ steps.parse_version.outputs.clean_version }}

      # 上传单个构建产物
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          # 使用包含类型后缀的名称，例如: build-windows-x64-cli
          name: build-${{ matrix.os_config.name }}-${{ matrix.app_config.type }}
          # 修正：根据日志确认 Nuitka 将文件输出到了 build/ 目录
          # 直接指定准确路径，不再使用通配符猜测
          path: build/${{ matrix.app_config.out_name }}${{ matrix.os_config.ext }}

  publish:
    needs: build
    runs-on: ubuntu-latest
    steps:
      # 下载所有构件
      - uses: actions/download-artifact@v4
        with:
          # 不指定 name 默认下载所有 artifacts
          # merge-multiple: true 会把所有下载的文件平铺到 path 目录中，自动处理了文件夹嵌套问题
          path: release
          merge-multiple: true

      - name: List Release Files
        run: ls -R release

      - uses: softprops/action-gh-release@v2
        with:
          files: release/**/*
