name: Build Download Clients

on:
  push:
    tags:
      - 'v*'
      - 'release-*'

# 权限最小化：只保留发布 Release 必需的权限
permissions:
  contents: write

env:
  CLI_ENTRY: scripts/ws_downloader.py
  DESKTOP_ENTRY: scripts/ws_desktop.py
  # 提取公共参数，减少重复。注意：--add-data 的分隔符由各 Job 动态追加
  PYINSTALLER_BASE_ARGS: >-
    --paths .
    --onefile
    --noconfirm
    --collect-all python_app
    --collect-data python_app.locales
    --name

jobs:
  linux:
    name: Linux ${{ matrix.arch_tag }}
    runs-on: ubuntu-latest
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: linux/amd64
            arch_tag: x64
          - platform: linux/arm64
            arch_tag: arm64
          - platform: linux/arm/v7
            arch_tag: armv7
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup QEMU
        uses: docker/setup-qemu-action@v3

      - name: Build binaries inside container
        env:
          PLATFORM: ${{ matrix.platform }}
          ARCH_TAG: ${{ matrix.arch_tag }}
          # Linux 使用冒号分隔
          ADD_DATA_ARG: "--add-data=python_app/locales:python_app/locales"
        run: |
          # 创建构建脚本
          cat <<'EOF' > docker_build.sh
          #!/usr/bin/env bash
          set -euo pipefail
          
          # 配置环境
          export HOME=/tmp
          export PATH="$HOME/.local/bin:$PATH"
          
          echo "::group::Install Dependencies"
          python -m pip install --upgrade pip --user --no-warn-script-location
          python -m pip install --user -r scripts/requirements.txt --no-warn-script-location
          python -m pip install --user pyinstaller --no-warn-script-location
          echo "::endgroup::"

          echo "::group::Setup UPX"
          export UPX_VERSION=4.2.4
          case "${ARCH_TAG}" in
            x64) UPX_PKG_ARCH=amd64_linux ;;
            arm64) UPX_PKG_ARCH=arm64_linux ;;
            armv7) UPX_PKG_ARCH=arm_linux ;;
            *) echo "Unsupported arch ${ARCH_TAG}" >&2; exit 1 ;;
          esac
          
          UPX_ROOT=/tmp/upx-src
          mkdir -p "${UPX_ROOT}"
          UPX_ARCHIVE="upx-${UPX_VERSION}-${UPX_PKG_ARCH}.tar.xz"
          # 增加重试机制
          curl -L --retry 3 "https://github.com/upx/upx/releases/download/v${UPX_VERSION}/${UPX_ARCHIVE}" -o "${UPX_ROOT}/${UPX_ARCHIVE}"
          tar -C "${UPX_ROOT}" -xf "${UPX_ROOT}/${UPX_ARCHIVE}"
          export UPX_DIR="${UPX_ROOT}/upx-${UPX_VERSION}-${UPX_PKG_ARCH}"
          echo "::endgroup::"

          echo "::group::Run PyInstaller"
          # 使用外部传入的环境变量构建
          pyinstaller ${CLI_ENTRY} ${PYINSTALLER_BASE_ARGS} feishu-downloader-cli ${ADD_DATA_ARG} --upx-dir "${UPX_DIR}"
          pyinstaller ${DESKTOP_ENTRY} ${PYINSTALLER_BASE_ARGS} feishu-downloader-desktop ${ADD_DATA_ARG} --upx-dir "${UPX_DIR}" --windowed
          echo "::endgroup::"

          # 移动产物
          mkdir -p artifacts
          mv dist/feishu-downloader-cli artifacts/feishu-downloader-cli-linux-${ARCH_TAG}
          mv dist/feishu-downloader-desktop artifacts/feishu-downloader-desktop-linux-${ARCH_TAG}
          
          # 修复权限，确保外部可以读取
          chmod -R 777 artifacts
          EOF
          
          chmod +x docker_build.sh
          
          # 运行 Docker，挂载 pip 缓存以加速后续构建（如果在同一 Runner 复用时有效）
          docker run --rm --platform "${PLATFORM}" \
            -v "${PWD}:/workspace" \
            -v "${HOME}/.cache/pip:/tmp/.cache/pip" \
            -w /workspace \
            -e ARCH_TAG \
            -e CLI_ENTRY \
            -e DESKTOP_ENTRY \
            -e PYINSTALLER_BASE_ARGS="${PYINSTALLER_BASE_ARGS}" \
            -e ADD_DATA_ARG="${ADD_DATA_ARG}" \
            python:3.12 bash /workspace/docker_build.sh

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: feishu-download-clients-linux-${{ matrix.arch_tag }}
          path: artifacts/*
          if-no-files-found: error

  windows:
    name: Windows ${{ matrix.arch_tag }}
    runs-on: windows-latest
    timeout-minutes: 45
    strategy:
      fail-fast: false
      matrix:
        include:
          - python_arch: x64
            arch_tag: x64
          - python_arch: x86
            arch_tag: x86
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          architecture: ${{ matrix.python_arch }}
          cache: 'pip' # 启用 pip 缓存

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r scripts/requirements.txt pyinstaller

      - name: Install UPX
        run: choco install upx -y --no-progress

      # PowerShell 处理 UPX 路径
      - name: Configure UPX directory
        shell: pwsh
        run: |
          $upxDir = Split-Path (Get-Command upx.exe).Source
          "UPX_DIR=$upxDir" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Build Binaries
        shell: pwsh
        # Windows 使用分号 ; 分隔
        env:
          ADD_DATA_ARG: '--add-data="python_app/locales;python_app/locales"'
        run: |
          pyinstaller $env:CLI_ENTRY $env:PYINSTALLER_BASE_ARGS feishu-downloader-cli $env:ADD_DATA_ARG --upx-dir "$env:UPX_DIR"
          pyinstaller $env:DESKTOP_ENTRY $env:PYINSTALLER_BASE_ARGS feishu-downloader-desktop $env:ADD_DATA_ARG --upx-dir "$env:UPX_DIR" --windowed

      - name: Prepare artifacts
        run: |
          New-Item -ItemType Directory -Path artifacts -Force | Out-Null
          Move-Item dist\feishu-downloader-cli.exe artifacts\feishu-downloader-cli-windows-${{ matrix.arch_tag }}.exe
          Move-Item dist\feishu-downloader-desktop.exe artifacts\feishu-downloader-desktop-windows-${{ matrix.arch_tag }}.exe

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: feishu-download-clients-windows-${{ matrix.arch_tag }}
          path: artifacts\*
          if-no-files-found: error

  macos:
    name: macOS ${{ matrix.arch_tag }}
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 45
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: macos-13
            arch_tag: x64
          - runner: macos-14
            arch_tag: arm64
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip' # 启用 pip 缓存

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r scripts/requirements.txt pyinstaller

      - name: Install UPX
        run: brew install upx

      - name: Build Binaries
        # macOS 使用冒号 : 分隔
        env:
          ADD_DATA_ARG: '--add-data=python_app/locales:python_app/locales'
        run: |
          UPX_DIR=$(dirname $(command -v upx))
          pyinstaller $CLI_ENTRY $PYINSTALLER_BASE_ARGS feishu-downloader-cli $ADD_DATA_ARG --upx-dir "${UPX_DIR}"
          pyinstaller $DESKTOP_ENTRY $PYINSTALLER_BASE_ARGS feishu-downloader-desktop $ADD_DATA_ARG --upx-dir "${UPX_DIR}" --windowed

      - name: Prepare artifacts
        run: |
          mkdir -p artifacts
          mv dist/feishu-downloader-cli artifacts/feishu-downloader-cli-macos-${{ matrix.arch_tag }}
          mv dist/feishu-downloader-desktop artifacts/feishu-downloader-desktop-macos-${{ matrix.arch_tag }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: feishu-download-clients-macos-${{ matrix.arch_tag }}
          path: artifacts/*
          if-no-files-found: error

  publish:
    name: Publish Release Assets
    needs: [linux, windows, macos]
    runs-on: ubuntu-latest
    permissions:
      contents: write # 明确 Release 权限
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: release
          merge-multiple: true # 自动合并同名目录（如果有），简化结构

      - name: List files
        run: ls -R release

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release/**/*
          generate_release_notes: true # 自动生成基于 Git 提交记录的 Release Note
          fail_on_unmatched_files: true
